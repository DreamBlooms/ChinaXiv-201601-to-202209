# 探空火箭数管设备设计与实现

许睿1,²，吴春静²，魏本杰²(1.中国科学院大学,北京100190;2.中国科学院空间科学与应用研究中心,北京100190)

摘要：针对目前探空火箭数据管理设备通用性较差的问题，以及对于航天器数管设备扩展性和可靠性不断增加的任务需求,设计了一种具备通用性和可扩展性的新型数据管理设备。设计使用TI最新推出的TMS570LS3137微控制器作为CPU,充分利用其所提供的片上资源，使得系统具有丰富的外部接口，包括IIC 接口、CAN总线接口、以太网接口和SD卡插槽。此外，外部存储器接 $\alpha$ (EMIF)提供的较大寻址空间可扩展多个外接板卡。在软件部分，系统采用了移植性较好的实时多任务操作系统 $\mu \mathbf { C } / 0 \ S - \pi$ ，配合各模块的驱动程序完成多任务的调用。该系统可满足多型探空火箭的仿真测试任务，具有较高的工程利用价值。

关键词：TMS570LS3137；嵌入式系统；测试系统； ${ \mu } \mathbf { C } / \mathbf { 0 } \mathbf { S }$ -ⅡI系统中图分类号：TP2 文献标识码：A 文章编号：1000-8829(2015)01-0087-04

# Design of Data Handling System for Sounding Rockets

XU Rui2,WUChun-jing2,，WEI Ben-jie² (1.University of Chinese Academy of Sciences,Beijing 100190, China; 2.Center for Space Science and Applied Research,Chinese Academy of Sciences,Beijing 1O0190,China)

Abstract:To solve the problem that data handling system for sounding rockets lacks feasibility,and increasing requirementson expansibilityandreliability of data handling system,a general and extensible data handling system is proposed.Thissystemuses TMS570LS3137 produced by TIas CPU,and hasabundant interfaces, such as IIC,CAN,Ethernetand SD card.EMIF interface provides external modules with addressing space.For software, ${ \mu } \mathbf { C } / 0 \mathbf { S } { - } \mathbf { I I }$ is ported to system and combines with drivers to complete invoking multitask.This system can satisfy various testing task and has high value in aerospace applications.

Key words: TMS57LS3137; embedded system; testing system; ${ \mu } \mathbf { C } / \mathbf { 0 } \mathbf { S } { - } \mathbf { I I }$

随着外层空间探测需求的日益提升，探空火箭搭载探测仪器的种类和数量不断增多，这对数据管理设备（以下简称数管设备)的功能性与可靠性提出了更高要求。另外，考虑到空间探测技术近十几年来的不断发展，数管设备应当具有可扩展、易升级的特点，以便于今后对其功能进行相应的扩展，从而适应新的空间探测的需要。结合该背景，设计了具有多功能、高可靠以及扩展性好的探空火箭数管设备，以适应不断进步的空间技术需要其能适应多种航天探测任务的需求，同时具备较强的升级能力。

# 1TMS570LS3137处理器简介

探空火箭数管设备的核心是TI公司开发的一款高性能、高可靠性的微控制器（TMS570LS3137），它集成了ARMCortex-R4F浮点型CPU，此CPU最高运算速度可达1.66DMIPS/MHz，并具有高达 $1 8 0 ~ \mathrm { M H z }$ 运行的配置。其丰富的片内资源与外设接口极大地简化了设计与开发流程，并提高了芯片的通用性。片上资源包括3MB的集成闪存和256KB的数据RAM，其可实现相应的读取、编程和擦除操作。丰富的外部通信接口模块包括:3个MibSPI,2个SPI,1个LIN,1个SCI,3个DCAN，1个IIC，1个以太网和1个FlexRay控制器。除此以外，此器件还具有2个12位分辨率的MibADC，以完成采样速率较低的模数转换任务。在强大的片内资源与外设支持下，TMS570LS3137还具有如下主要特点:

$\textcircled{1}$ 外部存储器接口（EMIF)可提高芯片外扩展功能，此功能可实现与同步DRAM（SDRAM)器件、异步存储器、外设或FPGA器件的对接。

$\textcircled{2}$ 拥有以锁步模式运行的双核CPU和存储器内置自检(BIST)逻辑闪存和数据SRAM上的ECC外设存储器的奇偶校验，使该芯片具有更高的安全性。

$\textcircled{3}$ 在代码调试方面，除内置的ARMCortex-R4FCoreSight调试特性外，还提供一个外部跟踪宏单元(ETM)进行程序执行的指令和数据跟踪。RAM的跟踪端口模块（RTP)可支持由CPU或者任何其他主控所访问的RAM和外设的高速跟踪。

鉴于以上特点，本设计选择了该款芯片作为系统的核心处理器。

# 2硬件平台设计

# 2.1数管设备硬件平台设计要求

该数管设备是一部通用、模块化、可扩展的嵌入式计算机系统样机,适用于多种型号探空火箭、微小卫星、科学仪器等航天器负载的地面检测试验。因此，系统的硬件平台需满足以下设计需求：

$\textcircled{1}$ 采集科学数据和工程参数，并将采集到的数据组织成符合遥测格式的数据源包；$\textcircled{2}$ 提供大容量的外设存储模块,使其具有数据管理和存储功能，并提供SD卡接口，以完成数据的备份与转存；$\textcircled{3}$ 对外提供多种接口通信功能，包括CAN总线、IIC总线、以太网接口等,便于进行数据的采集和传输；$\textcircled{4}$ 具备外部设备扩展功能，便于系统的升级，提升可扩展性。

# 2.2数管设备总体结构

鉴于上述要求，以TMS570LS3137作为CPU的硬件平台可充分应用其片内的CAN、IIC、SPI、以太网接口等资源,并利用EMIF接口进行外设的扩展。其总体结构如图1所示。

# 2.3硬件外设模块接口

（1）IIC接口。

IIC 是一个双向总线，它使用两条线：串行时钟线(SCL)和串行数据线(SDA)实现互连芯片的控制，每个器件通过唯一的地址来识别。设计所选用TMS系列微处理器提供的IIC接口支持100 kbit/s和400kbit/s的速度。另外，在外部接口处添加总线缓冲器P82B96，以提供更好的抗干扰能力，以及增加总线的负载能力。

(2）CAN总线接口。

TMS70系列包含3个CAN控制器,其拥有的DCAN支持CAN2.0B协议标准，并使用一个串行、多主机通信协议，此协议有效支持对速率高达1Mbit/s的稳健通信的分布式实时控制。物理层选用SN65HVD-232作为电平转换器件，以完成CAN总线通信。

(3）以太网接口。

TMS570LS3137内置以太网接口可实现10/100M的网络传输速度，并且支持MII与RMII两种工作模式。外部的PHY芯片选择TI的DP83640，此器件嵌人了IEEE1588精密时间协议的时钟关键部分，允许高精度的IEEE1588节点实现。本设计选用MII全双工工作模式,100Mbit/s传输速率,接收端的参考时钟为 $2 5 ~ \mathrm { M H z }$ 。

(4）SD卡接口。

SD卡接口设计利用了片内的SPI接口模块，所接入的SD卡将工作在SPI模式下。该模式可看作一种简单的命令响应协议，主控制器发出命令后，SD卡对不同命令返回对应的响应。在SPI模式下，共有3种响应类型：R1、R2 和R3,分别占1、2和3个字节。在硬件设计中一共使用了4根串行总线连接SD卡插槽，分别是主机输出从机输人数据线（MISO）、主机输入从机输出数据线（MOSI）、片选（CS）和串行时钟(SCLK)。

3.3V DATA[15:0] 供电电源 1.5V Address[21:0] RST CS0 模拟板 （模拟量采集）   
复位模块 Pro_RST 中断信号（INT） 读写控制信号 clk 117T1113331   
时钟模块 DATA[15:0] Address[21:0] LAN 数字板1   
以太网接口 CS1 (复接与 中断信号(INT) RS编码) SDA 读写控制信号   
IIC总线接口 SCL CAN_RX DATA[15:0]   
CAN总线 CAN_TX Address[21:0] 数字板2 CS2 （多路串口与 MISO 中断信号(INT） LVDS接口)   
SD卡接口 ck \$\$ 读写控制信号 MOSL

# 2.4扩展模块设计

TMS570LS3137特有的EMIF接口为系统增加外部扩展模块提供了便利，使得设备具有较好的可扩展性和易升级性。EMIF接口包含22位地址总线，加上4块BANK地址，若使用16位数据总线宽度，其外部寻址范围可高达 $3 2 ~ \mathbf { M B }$ 。除此之外，它还包含4个片选信号，除去CSO用于使能SDRAM外，CS2、CS3和CS4可为外接扩展板卡提供丰富的片选使能信号。图2所示为外部扩展接口框图，其中DQM信号可控制使能数据位高8位/低8位信号的有效性，增加外接数据传输的灵活性。WE为写使能端，可控制数据的读取，INT为外接板卡所发出的中断信号，帮助CPU主板及时处理外部模块的任务请求。测试系统为外接扩展部分分配地址段为 $0 \mathbf { x } 6 0 0 0 0 0 0 0 0 \sim 0 \mathbf { x } 6 \mathbf { B } \mathbf { F } \mathbf { F } \mathbf { F } \mathbf { F } \mathbf { F } \mathbf { F } _ { \mathrm { c } }$

CPU主板 外接板卡EMIF_nCS[x] nCsEMIF_nWE nWEEMIF_BA[1:0] BA[1:0]INT[x] INTRST RSTEMIF_A[21:0] A[21:0]  
EMIF_nDQM[0] LDQM  
EMIF_nDQM[1] UDQMEMIF_D[15:0] DQ[15:0]

# 3系统软件设计

# 3.1 $\mu \mathrm { C } / 0 \mathrm { S } \cdot \mathrm { I I }$ 简介

该数管设备的软件部分使用实时多任务操作系统${ \mu } \mathbf { C } / 0 \mathbf { S } { \cdot } \mathbf { I I } ,$ 。由 $\mu \mathrm { c } / 0 \mathsf { S } \cdot \pi$ 提供应用软件运行的基本环境和接口，实现资源管理、进程的调度、同步、通信与运行管理、存储器与IO管理等功能。

$\bf { \mu c / O S - I I }$ 是一个完整的，可移植、固化、裁剪的占先式实时多任务内核。 $\mu \mathrm { C / O S - I I }$ 系统绝大部分用ANSI的C语言编写，包含一部分汇编语言代码，使之可供不同架构的微处理器使用。用户只要有标准的ANSI的C交叉编译器，有汇编器、连接器等软件工具，就可以将 $\mu \mathbf { C } / 0 \ S - \mathbf { I I }$ 嵌入到开发的产品中。 $\mu \mathrm { C / O S - I I }$ 具有执行效率高、占用空间小、实时性能优良和扩展性强等特点。严格来说，它只是一个实时操作系统内核，仅仅包含了任务调度、任务管理、时间管理、内存管理、任务间通信和同步等基本功能，而没有提供输入输出管理、文件系统、网络等额外的服务。

# 3.2 $\mu \mathrm { C / O S - I I }$ 操作系统的移植

为了在所设计的系统中运行 ${ \mu } \mathbf { C } / 0 \mathbf { S } { \cdot } \mathbf { \pi }$ 操作系统，需要将其内核移植到TMS570LS3137平台上。其实质是需要修改与CPU类型有关的源码文件OS_CPU.H、OS_CPU_C.C和OS_CPU_A.ASM。其中OS_CPU.H定义了与编译器相关的数据类型、堆栈的增长方向，以及关中断和开中断和任务间切换的宏定义。OS_CPU_A.ASM为对处理器的寄存器进行操作，由汇编语言编写。其包含4个子函数：OSStartHighR-dy（）、OSCtxSW（）、OSIntCtsSw（）和OSTickISR（）。第1个函数在多任务系统启动函数OSStart（）中调用，将就绪表中最高优先级的任务从中断返回到运行态；第2函数在任务切换函数中调用；第3个函数实现中断级任务切换，OSTickISR()为系统时钟节拍中断服务函数，为内核提供时钟节拍。OS_CPU_C.C完成堆栈初始化以及内核扩展等应用。

# 3.3 应用任务设计

系统软件部分工作流程图如图3所示。主要分为系统初始化和多任务的调用两大部分。

（1）系统初始化。

在系统初始化过程中，程序通过调用BSP_Init对板级外设进行初始化，接下来通过CPU_Init完成对CPU内部各寄存器及存储器的初始化工作，OS_Init完成操作系统环境的初始化工作，包括初始化系统任务中所用的全局变量、定义任务优先级、定义任务控制块，以及完成任务堆栈初始化。

# (2）多任务调用。

在完成系统初始化之后，将创建应用任务，实现地检系统采集和传输数据的任务需求。主要包括IIC、CAN总线、以太网口和SD卡存取操作。在具体任务调用过程中，首先进行任务的初始化，如调用各外设模块驱动程序中的初始化函数IIC_Init、CAN_Init等，定义所需的端口地址，配置相应的控制寄存器，选取工作模式。接下来在后续的任务调用函数中对外设的地址与寄存器进行读写操作，完成测试数据的采集与存储。其中以太网口的操作还需考虑TCP/IP协议栈，并为系统分配相应的IP地址，来完成与其他设备的网络通信。

![](images/8812e7e1d7d299b9b12f48df43b540bbd49834377cd7d1c4fd0c637a8652f15f.jpg)  
图2CPU主板外部扩展接口图  
图3系统任务调用流程图

# 4系统调试

本设计的调试利用了TMS570LS3137的JTAG（一种国际标准测试协议)接口，通过J-link仿真器连接

PC，板级供电电压为 $+ 5 \mathrm { V }$ 。电路连接如图4所示。PC机中使用开发环境为IAREWARM6.5，通过此IDE可完成工程的编译、下载、运行和调试。

![](images/b9c6903661e35603440b85a6f8f611f04d9a6f28a12e959611967c01b065e4af.jpg)  
图4系统上电联机调试  
图5系统上电联机调试

在调试过程中，首先进行硬件调试，使用万用表、示波器等仪器检测电路硬件连接是否正常。在IAR中编写相关接口的裸机驱动程序，通过示波器观察数据读写是否正常。硬件调试完成后，进行 $\mu \mathrm { C } / 0 \mathsf { S } \ – \mathbf { I I }$ 的操作系统移植工作。为方便判断操作系统运行状态，在N2HET1[25]端口处引出LED指示灯，操作系统启动后，此LED会以 $5 0 0 \ \mathrm { m s }$ 的时间间隔开始闪烁。软件调试中可通过查看内部寄存器值的变化以及配合串口的输出打印来检测系统软件运行情况。以EMIF读写接口调试为例,在读取外部存储接口总线上的数据过程中，为查看方便，将其存人CPU内部RAM（起始地址为 $0 \times 0 8 0 0 4 0 0 0 )$ 中,接着在IAR中调用Memory调试模块进行观察。测试时，在总线上依次传输32的余数值，可观测到RAM中的写人情况，如图5所示。

Goto Memoty8 □ 1 a   
08004000 00 00 00 01 00 00 00 02 00 00 00 03 00 00 UU 04   
08004010 00 00 00 05 00 00 00 06 00 00 00 07 00 00 00 08   
08004020 00 00 00 09 00 00 00 0a 00 00 00 0b 00 00 00 0c   
08004030 00 00 00 0d 00 00 00 0e 00 00 00 0f 00 00 00 10   
08004040 00 00 00 11 00 00 00 L 00 00 00 13 00 00 00 14   
08004050 00 00 00 15 00 00 00 16 00 00 00 17 00 00 00 18   
08004060 00 00 00 19 00 00 00 00 00 00 1b 00 00 00 1c   
08004070 00 00 00 1d 00 00 00 00 00 00 1f 00 00 00 00   
08004080 00 00 00 01 00 00 00 02 00 00 00 03 00 00 00 04   
08004090 00 00 00 05 00 00 00 06 00 00 00 07 00 00 00 08   
080040a0 00 00 00 09 00 00 00 0a 00 00 00 0b 00 00 00 0c   
080040b0 00 00 00 0d 00 00 00 0e 00 00 00 0f 00 00 00 10   
080040c0 00 00 00 11 00 00 00 12 00 00 00 00 00 00 14   
080040d0 00 00 00 15 00 00 00 16 00 00 00 00 00 D0 18   
080040e0 00 00 00 00 00 00 00 00 00 1b 00 00 lc   
080040f0 00 00 00 1d 00 00 00 00 00 00 00 00   
08004100 00 00 00 01 00 00 00 02 00 00 00 03 00 00 00 04   
08004110 00 00 00 05 00 00 00 06 00 00 00 07 00 00 00 08   
08004120 00 00 00 09 00 00 00 Ua 00 00 00 0b 00 00 00 0c   
08004130 00 00 00 0d 00 00 00 00 00 1   
08004140 00 00 00 00 00 00 00 00 00 00 00 U   
2 08004150 n0nn n nn nn nn nn

# 5结束语

经过调试，该数管设备各项功能到达了设计目的，配合可外接扩展适用于不同型号探空火箭载荷的测试板卡，可满足多种仿真测试任务。此外，设计中选用的高性能的CPU芯片也使得系统具有更好的安全性和较短开发周期，在航天工程领域有很好的工程利用价值。

# 参考文献：

[1]Texas Instruments Inc.TMS570LS3137 16/32-Bit RISCFlash Microcontroller[Z].2011.  
[2] LabrosseJJ.嵌人式实时操作系统 ${ \mu } \mathbf { C } / 0 \mathbf { S } \mathbf { - } \mathbf { I I } \left\{ \mathbf { M } \right\}$ .邵贝贝，译.北京：北京航空航天大学出版社,2003.  
[3] 丁国超. ${ \mu } \mathbf { C } / 0 \mathbf { S } { \cdot } \mathbf { I I }$ 实时操作系统在ARM微处理器上的移植[D].哈尔滨：哈尔滨理工大学，2005.  
[4] 张玉凤.基于ARM7的轻小型化数据管理系统设计研究[D].北京：中国科学院研究生院（空间科学与应用技术研究中心），2011.  
[5]Texas Instruments Inc.TMS570LS31x/21x 16/32-Bit RISCFlash Microcontroller Technical Reference Manual[Z].2012.

# （上接第86页）

的数据融合方法和控制技术储备。

# 参考文献：

[1］付双飞,王洪光,房立金，等.超高压输电线路巡检机器人越障控制问题的研究[J].机器人，2005，27（4).  
[2] 李鹏，马书根,李斌,等.具有自适应能力管道机器人的设计与运动分析[J].机械工程学报，2009（1).  
[3] Knightscope-World's Frist Robotic Security Guard[EB/OL].2014-01-03.http://wonderfulengineering.com/knight-scope-worlds-first-robotic-security-guard/.  
[4] 刘祺，王银玲，吴林恒.基于STM32的图像采集与显示系统的研究与设计[J].数字技术与应用，2012(2)：94-99.  
[5] 柳玲，温玄.基于摄像头传感器的智能车路径提取及应用[J].重庆理工大学学报（自然科学）,2013(5)：69-74.  
[6]梁明亮,陈志红.一种智能探测机器人的设计与实现[J]计算机测量与控制，2012,20(10)：2757-2760.  
[7]周熊.基于AT89C52单片机的烟雾报警器设计[J].电子设计工程，2013(1)：164-166.  
[8] 邢永友.基于GPS的机器人导航技术的研究[J].农业科技与装备，2011(2)：79-83.  
[9] 李传格，韦巍.助行机器人导航与远程监护系统的设计与实现[J].传感器与微系统，2011(10)：112-114.  
[10] 申晓霞，张桦，高赞，等.基于深度信息和RGB图像的行为识别算法[J].模式识别与人工智能，2013（8)：722-725.  
[11] 王进，任小龙,孙开伟，等.HSV颜色空间下用演化超网络识别道路限速标志的研究[J].高技术通讯,2013，23(7):679-684.  
[12] 解文华，肖进胜，易本顺,等.一种基于MeanShift和C-V模型的车辆跟踪算法[J].湖南大学学报（自然科学版），2012,39(7)：31-35.