# 基于互联网支付技术的货币自动兑换机

周志坚，杨贵中，刘宏杰，汪银盘（吉林大学 仪器科学与电气工程学院，吉林长春 130026)

摘要：随着互联网支付技术的快速发展，本文研究了一种利用微信支付技术实现自动兑换硬币功能的设备，用于解决日常生活中小面额货币的兑换问题，实现“零现金”出行。该设备具有小面额纸币兑换硬币和微信支付兑换硬币的功能。针对该设备的软硬件模块、整体布局、设备的稳定性和兑换的准确性，本文进行了相关设计和研究。实验结果表明，该设备安全稳定，能够满足日常生活中的兑换需求。

关键词：互联网；微信支付；货币兑换；准确性

中图分类号： 文献标志码： 文章编码： A money-changers based on Internet payment technology

ZHOU Zhijian;YANG Guizhong;LIU Hongjie;WANG Yinpan (College of Instrumentation & Electrical Engineering, Jilin University, Changchun 130026,China)

Abstract:With the rapid development of Internet payment technology,This paper studies a device which used WeChat payment technology,realizing the automatic conversion function of the coin to salve the problem of small denomination currency exchange in daily life,to achieve "zero cash" travel.The device has two functions,paper money for coins and WeChat pay for coins.For allaspects of the device，including hardware andsoftware modules， overall layout ， stability and correctness of the exchange process ， we had done some research and design.The results of experiment show that the device is safe and stable,can meet people's daily money exchange requirements.

Key words: Internet; WeChat payment; currency exchange; accuracy

# 0引言

随着网络支付的迅速普及，人们越来越习惯于使用移动设备进行支付，这种快捷安1全的支付方式让“零现金”出行成为大势所趋。继1角5角券硬币化之后，山东省部分地市启动实施“1元券硬币化工程”，目前世界上很多国家都在小额基础货币上采用了硬币，淘汰1元纸币也符合发展趋势。此外1元5角硬币的投放有利于自动售货机、停车场自动收费机、地铁和公交自动售票机的推广应用，方便人们的生活。但是由于硬币不便携带，能够通过互联网支付快捷兑换硬币成迫切需求。目前市场上没有可以通过互联网支付兑换硬币的设备，现有能够部分实现货币兑换的设备有自助硬币兑换机和自动售货机。但其功能单一，使用局限性大，因此在现有设备的基础上进行功能调整和软件创新，实现通过互联网支付直接兑换小额货币具有更加现实的意义。

本文研究的一台以STM32为主处理器的兑换机，在现有自助硬币兑换机和自动售货机功能的基础上，进行了功能创新及整合，大大减小了设备的体积，增加了微信支付兑换硬币的功能，使其既可以现金兑换硬币又可以互联网支付兑换硬币。在微信支付时使用二维码在兑换机与移动设备之间传输信息，提高了支付的安全性。

# 1硬件系统架构

如图1所示，该自动兑换机的硬件系统构架以STM32作为主板，驱动和控制纸钞机、出币器、显示屏和按键，电源盒向主板、纸钞机和出币器提供电源。以下是格个硬件模块的简单介绍：

![](images/fc83bbdc6dce81478cbafc64676c5f3454a81e70eaadf1b390c88765f2838732.jpg)  
图1硬件系统构架  
Fig.1Hardwaresystemstructure

# 1.1 电源盒

MD—9916A—24V电源盒可以将220V的日常交流电压转换为24V、12V和5V的直流供电电压，输出功率仅130W,工作效率高，输出纹波噪音低，很适合作电源为各个工作模块供电。

# 1.2 STM32主板

STM32系列属于中低端的32位ARM微控制器，该系列芯片是意法半导体（ST）公司出品，其内核是Cortex-M3。芯片集成定时器，CAN，ADC，SPI，I2C，USB，UART，等多种功能。

# 1.3退币器

退币器被广泛用于各种游戏机和兑币机，本设备选用的港都8孔马达退币器，工作电压24V，0.4A，斗内最大可储装2000 枚硬币，具有反应快速、出币准确的优点。

# 1.4纸钞机

纸币识别器根据不同面额的钞票具有不同的特征，如纸质、磁性、幅面大小等，利用荧光检测技术和磁性检测技术，分辨纸钞的真假及面额。

# 1.5显示屏

液晶显示器，为平面超薄的显示设备，它由一定数量的彩色或黑白像素组成，放置于光源或者反射面前方。它的主要原理是以电流刺激液晶分子产生点、线、面配合背部灯管构成画面。本设备中的3.2寸TFT液晶屏的分辨率为 $2 4 0 ^ { * } 3 2 0$ ，功耗为 $5 . 5 { \sim } 6 . 3 \mathrm { W }$ 。

# $1 . 6 \ 3 { ^ { * } } 4$ 按键

矩阵按键，它是单片机外部设备中所使用的排布类似于矩阵的键盘组，用于从外部输入信号。当按键没有按下时，所有输入端都是高电平，代表无键按下。当有键按下时，会输入低电平，通过读取输入线的状态就可得知是否有键按下了。

# 2软件系统构架

# 2.1纸币兑换硬币模块控制流程

打开设备电源，系统初始化后进入正常运行状态，等待纸钞机信号；当纸钞机收钞后，系统通过纸钞机发送来的数据判断接收到的纸币面额，并计算出相应的退币数；然后系统启动中断控制器和定时器并驱动退币器开始退币；退币结束后关闭中断、定时及退币器，回到未收钞状态，等待再次兑换。模块工作流程如图2所示。

![](images/ba1ccf8ef98222130b25fbc29759b7200a047e0c6d586da3b7a9c9c4d1a07385.jpg)  
图2纸币兑换硬币模块控制流程Fig.2 Control flow of "banknote exchange tocions"module

# 2.2微信支付兑换硬币模块控制流程

系统供电后进行初始化操作，随后进入正常工作状态，循环等待按键的串口信号，用户通过按键选择兑换金额，按确定以后处理器进行分析处理，并生成随机的六位验证码，之后将带有验证码的二维码输送到显示器，二维码的本质是一个链接，用户通过微信扫描二维码，链接到后台服务器，完成服务器与手机的通信，当服务器接收到用户的付款信息后便将6位验证码发送给用户，用户将验证码输入兑换机，处理器把接受到的验证码与之前随机生成的验证码进行核对，如果正确就发送信号输出相应的硬币，如果错误则提示错误。模块工作流程如图3所示。

![](images/6eb9ec04fea26159747083f04d3e4f4897e9bbacbb7e57fab34c1ecf372602f5.jpg)  
图3微信支付兑换硬币模块控制流程  
Fig.3 Control flow of "WeChat electronic money exchange to coins"module

# 2.3微信支付

微信 (WeChat)是腾讯公司于2011年1月21日推出的一个为智能终端提供即时通讯服务的免费应用程序。微信支持跨通信运营商、跨操作系统平台通过网络快速发送语音短信、视频、图片和文字。微信公众平台是微信的一个功能模块。在本文中，微信公众平台是我们通过微信为用户提供兑币服务的平台。公众平台开发接口是提供服务的基础，我们在公众平台网站中创建公众号、获得接口权限后，即可在微信公众平台开发文本的帮助下开发，此处不再详述。

我们将一个链接转化为二维码，用户使用微信扫描二维码，微信自动链接到公众号后台，实现用户和微信后台的交互。用户支付完成后，公众号后台将验证码返回给用户手机，用户往兑币机输入验证码，输入完成后兑币机开始校对验证，正确即启动中断，吐出相应的硬币，错误即发出提示。微信的支付和转账功能，以及微信公众平台强大的开发应用使本机器的互联网兑币得以实现。

# 2.4二维码的生成技术

由于本设备需要将手机与服务器进行链接，最方便的方式就是将验证码及链接生成二维码，用户扫码即可实现与服务器的通信。二维码是用某种特定的几何图形按一定规律在平面（二维方向上）分布的黑白相间的图形记录数据符号信息的。二维码存储的数据量大，可以包含数字、字符，及中文文本等混合内容，有一定的容错性（在部分损坏以后可以正常读取），空间利用率高。二维码生成代码庞大，算法复杂，内存较小的STM32无法放下二维码的庞大数据。可以使用网上的开源QR码，由于开源代码是在LINUX平台上运行的，为适应STM32，做一些移植工作即可。

# 3实验结果及分析

# 3.1兑换机实物图

![](images/ea9e1607c5e6114b0b2fdf2ffcb88559172629b430e2788378a6af604faf49a0.jpg)  
图5二维码生成结果

![](images/6ae43430c447bcca9ffbbfe8e424e6690e6a6055e4260529b8309a255f955fdf.jpg)  
图4实物图  
Fig.4 The picture of the machine

尺寸（mm）： $5 0 0 { * } 2 5 0 { * } 5 0 0$

左上第一张图，左侧为纸钞机，中间部分为按键，右侧为显示屏。右上第二张图为吐币口。左下第三张图可以看到纸钞机。右下第四张图为电源线。

# 3.2验证码随机性测试及结果

为了获得回馈信号及保障支付安全，本设备使用STM32作为主板，随机生成六位的验证码。为了验证验证码的随机性，从而确保每次的二维码的唯一性，我们对同一兑币金额进行了多次试验，对不同兑币金额进行了多次试验。对大量测试结果整理得下表从表中可以看到，验证码完全是无规律随机生成的，短期中几乎不可能生成完全重复的验证码。由于验证码是作为二维码的一部分信息，所以也就确保了每次兑币是二维码的唯一性，进而说明兑币足够安全的，完全满足设备要求。

<html><body><table><tr><td>兑换金额</td><td colspan="7">20次试验生成的验证码</td></tr><tr><td>1元</td><td></td><td></td><td></td><td></td><td></td><td>493583 157349 613482 244371 943367 543168 746281 015746 487351 164872 339441 149732 448256 648771 124060 346715641578312435973465 315479</td><td></td><td></td></tr><tr><td>5元</td><td></td><td></td><td></td><td></td><td></td><td>349751 164825347751 433543 846791 216487 102556 794152731684 439715 394137 081883 429932 526518 773170 327488 856914 801001069545867640</td><td></td><td></td></tr><tr><td>10元</td><td></td><td></td><td></td><td></td><td></td><td>965481 309041 414876 314054 087764013645369742 469746 764158 564821 564408 310405492113336879 794885 412649895425994794422615 223579</td><td></td><td></td></tr></table></body></html>

# 3.3设备出币的稳定性测试及结果

本设备的出币器使用24V0.4A的退币器，为了保障出币的稳定流畅，我们测试了20组从投入纸币到出币结束所需要的时间，结果整理如下表，表中我们可以看出每次出币的时间大概在3.95s左右，平均绝对偏差为0.17，说明设备出币速度快，而且十分稳定。

<html><body><table><tr><td colspan="3">出币时间(s)</td><td>平均用时</td><td>平均绝对偏差</td></tr><tr><td>4. 21 3. 48 4. 04 3. 50 3. 92</td><td>3. 96 3. 76 4. 19 3. 82 4. 19 4. 10 3. 97 3. 76 4. 18 3. 94</td><td>3. 80 3. 84 4. 13 4. 11 4. 09</td><td>3. 9495</td><td>0. 17255</td></tr></table></body></html>

# 3.4兑币准确性测试及结果

本设备为兑币机，其最重要的性能指标是兑币的准确行，为此，我们测试了一元、五元、十元的纸币和一元、五元、十元的微信支付线上货币，得到出币个数。从测试样本结果可以看到，同一币种的不同面额，不同币种的同一面额，出币个数与兑换金额相同。从而说明了该设备可以准确地兑换。

Fig.7 The accuracy test results   

<html><body><table><tr><td colspan="2">支付方式</td><td colspan="3">现金支付</td><td colspan="3">微信支付</td></tr><tr><td colspan="2">支付金额</td><td>1元</td><td>5元</td><td>10元</td><td>1元</td><td>5元</td><td>10元</td></tr><tr><td rowspan="15">出 币 数 目 （枚</td><td>第1次试验</td><td>1</td><td>5</td><td>10</td><td>1</td><td>5</td><td>10</td></tr><tr><td>第2次试验</td><td>1</td><td>5</td><td>10</td><td>1</td><td>5</td><td>10</td></tr><tr><td>第3次试验</td><td>1</td><td>5</td><td>10</td><td>1</td><td>5</td><td>10</td></tr><tr><td>第4次试验</td><td>1</td><td>5</td><td>10</td><td>1</td><td>5</td><td>10</td></tr><tr><td>第5次试验</td><td>1</td><td>5</td><td>10</td><td>1</td><td>5</td><td>10</td></tr><tr><td>第6次试验</td><td>1</td><td>5</td><td>10</td><td>1</td><td>5</td><td>10</td></tr><tr><td>第7次试验</td><td>1</td><td>5</td><td>10</td><td>1</td><td>5</td><td>10</td></tr><tr><td>第8次试验</td><td>1</td><td>5</td><td>10</td><td>1</td><td>5</td><td>10</td></tr><tr><td>第9次试验</td><td>1</td><td>5</td><td>10</td><td>1</td><td>5</td><td>10</td></tr><tr><td>第10次试验</td><td>1</td><td>5</td><td>10</td><td>1</td><td>5</td><td>10</td></tr><tr><td></td><td>11</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>第11次试验</td><td></td><td>55</td><td>11</td><td>11</td><td>55</td><td>11</td></tr><tr><td>第13次试验</td><td>1</td><td>5</td><td>10</td><td>1</td><td>5</td><td>10</td></tr><tr><td>第14次试验</td><td>1</td><td>5</td><td>10</td><td>1</td><td>5</td><td>10</td></tr><tr><td>第15次试验</td><td>1</td><td>5</td><td>10</td><td>1</td><td>5</td><td>10</td></tr><tr><td>第16次试验</td><td>1</td><td>5</td><td>10</td><td>1</td><td>5</td><td>10</td></tr><tr><td>第17次试验</td><td>1</td><td>5</td><td>10</td><td>1</td><td>5</td><td>10</td></tr><tr><td>第18次试验</td><td>1</td><td>5</td><td>10</td><td>1</td><td>5</td><td>10</td></tr><tr><td>第19次试验</td><td>1</td><td>5</td><td>10</td><td>1</td><td>5</td><td>10</td></tr><tr><td>第20次试验</td><td>1</td><td>5</td><td>10</td><td>1</td><td>5</td><td>10</td></tr></table></body></html>

# 4结语

本文研究了一台基于互联网支付技术的货币兑换设备，详细介绍了各个硬件模块的功能，整体的系统架构，互联网支付的原理和二维码的生成技术。测试了验证码生成的随机性、设备吐币的流畅性和兑币的准确性试验结果证明，该货币兑换机能够实时监测纸币识别器和键码的输入信号，并能根据接受到的信号做出迅速反应；采用随机生成的验证码能够确保二维码的唯一性，从而保障支付的安全性；出币快速平稳且准确。该设备具有安全和稳定的特点，完全满足预期的要求。

# 参考文献

[1]刘强,王川北,于子淞.基于STM32的二维码生成与显示系统的研究[J]信息技术与信息化,2015,10:174-176.  
[2]郑莹莹.基于STM32的嵌入式防破解自动兑币机系统[N].广东广播电视大学学报,2014,23(6):105-110.[3]范竞成．二维码生成方法及装置[P].中国专利:106156820,2016-11-23.  
[4]程序．二维码生成和验证方法[P].中国专利:104881698,2015-09-02.  
[5]张梅.基于微信的电动汽车充电运营平台实现[J].软件导刊,2016,15(8):77-79.  
[6]黄兴建,石修路,黄其河.基于微信微信公众平台的高铁客运订餐服务系统设计[J].超星,2016,(3):42-47.  
[7]徐国辉,陈婕娴.手机二维码技术原理及应用[J]信息与电脑,2013,01:18-19.  
[8]陆继远.自动售货机控制系统的设计与实现[J].微计算机信息,2011,27(8):36-38.