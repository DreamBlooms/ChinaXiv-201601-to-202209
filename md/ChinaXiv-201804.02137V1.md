# 基于规则网格的层次化布料动态模拟方法

郑华，王美丽，李书琴(西北农林科技大学，信息工程学院，陕西 咸阳 712100)

摘要：在布料动态模拟仿真过程中，收敛速度和模拟效率是两个核心指标，可以很好地反映布料在动态过程中的模拟效果。针对布料动态模拟中的收敛速度慢、模拟效率低的问题，提出了一种基于规则网格的层次化模拟方法，实现了基于位置的层次化动态模拟。在该方法中，利用层次化思想在原始网格的基础上构建层次化约束网格。在这个过程中，可以采用不同的决策函数对网格进行精简，构造出更加满足目标要求的约束网格，在构造完成后利用提出的权值关联模型对各层次进行再矫正。在模拟过程中，原始网格利用层次化约束网格从最粗层到最精细层进行收敛矫正，有效避免了传统为提高收敛速度而单一的增加约束矫正迭代次数的问题。为了检验模拟性能，布料在周期钟摆风场下进行了实验。实验表明，在基于规则网格的层次化方法模拟下，能很好地解决传统模拟的约束震荡问题，并且效率高、稳定性好。

关键词：层次化；动态模拟；收敛；布料模拟 中图分类号：TP311 doi:10.3969/j.issn.1001-3695.2017.12.0860

# Cloth simulation based on grid-hierarchical dynamic simulation method

Zheng Hua, Wang Meili, Li Shuqin† (College ofInformation Engineering,NorthwestA&FUniversity,Xianyang Shaanxi 71210o,China)

Abstract:Intheprocessofclothdynamicsimulation,convergenceandeficiencyaretwocore indicators,whichcanwellreflect the performanceof simulation.To approve theconvergence and qualityin cloth dynamic simulation,this paper proposedan approach which basedon grid-hierarchicalsimulation.Inthis method,this paper constructedahierarchical constrained gridon thebasisoftheoriginalgridusing thehierarchicalidea,inthis proces,various decision functionscouldbeused to streamline the gridtoadaptdifferent targetrequirements.Afer theconstruction wascompleted,itused theproposed weightedassociation modeltorectifyeachlevel.Intheprocessofsimulation,theproposedapproachusedhierarchicalconstraintgrid toconstrainthe original gridfromthecoarselayertothefinestlayer toimprove theconvergence speed,whichefectivelyavoidedtheproblem ofincreasing the numberof iterations in the traditional way.Toshow the simulation performance,itsimulates dynamic cloth under thecyclependulum windfield.Theresultsshows thatunderthesimulationof grid-herarchical method,itcanwelsolve the constraint oscilation problemofthe traditional simulation,andtheproposed method is more eficiencyand stable.

Key words:hierarchical; dynamic simulation; convergence;cloth simulation

# 0 引言

在在计算机动画中，布料动画模拟是重要的研究方向之一，受到了很多研究者的关注。如何让一个平面真实的反映出其自身的连贯性、拉伸性、碰撞性和受到外力的反应成为了研究的重点[1。目前已有的众多算法在效果、效率以及真实性上的差异性较大，所以研究一个综合性更强、效果更好、效率更高的模拟算法是当前布料模拟的重点研究方向，同时也为后续其他材质的模拟奠定基础。布料动画模拟包括了对于布料建模、数值计算与模拟方法三个方面。

对于布料模拟的建模有以下三种比较典型的方法：第一种就是根据一些经验性的几何方程来表示材质特有的物理特性，其优点是可以高效生成的良好的模拟效果。典型的模型有悬链线模型、纯几何变换形变模拟模型、基于纹理生成皱褶模型与双层几何模型（衣服层、皮肤层)。第二种是基于布料的摩擦、弹性系数等物理特征，通过构造三角网格或矩形网格的结构力学模型和能量状态模型，然后根据动力学方程进行数值求解，其优点是可以更加逼真的显示布料。该方法又分为连续体模型和离散体模型。连续体模型典型的有弹性形变模型、线性应变力模型、非线性应变力模型和细分有限元模型。目前对于离散型模型研究最为深入，典型的代表有Breen 等人[2提出的粒子模型、Provot[3]提出的质点-弹簧模型、Kikuuwe[4]提出的通用粒子模型。第三种就是综合以上两种方法的优点，即几何模型的高效性和物理模型的逼真性。除了以上几种典型的模型外，Lu 等人[提出了一种基于NURBS的物理模型。该模型在布料仿真程度上达到了新的高度，但是仍然存在模拟效率低和布料收敛速度慢等问题。

对于数值计算有以下四种典型的求解模型：a)显式Eluer积分方法，该方法相较于其他方法算法效率更高；b)隐式Eluer积分方法，主要应用于解决刚性材料的模拟；c)4 阶Runge-Kutta积分框架，该方法的优点是模拟精度高、模拟效果良好，缺点是算法效率较低，不能实时显示结果；d)Verlet积分框架，该方法针对几种方法的缺点进行了改进，耗时少且模拟效果精度较高。本文在布料建模上使用通用粒子模型，在计算方法上采用Verlet方法对目标网格进行求解。

在布料模拟的过程中，力学模型中传统的方法是利用牛顿力学方程求解，通过利用加速度与质点质量对动态物体的运动轨迹进行求解，其中存在与真实相差较大的模拟误差。因此，基于此方法研究的主要目的是尽可能降低误差，以此提高模拟效果，而巨额的运算导致了显示模拟结果时出现卡顿和逼真性下降等问题。

在碰撞检测方面上，传统方法需要依赖于包围体结构进行加速检测，如常见的方法如球包围、规则矩形包围、8-DOP等，虽然可以检测碰撞，但是明显影响了模拟的效果。虽然近些年也有一些优秀的碰撞检测算法如TightCCD[5]、虚拟分解方法[6]等使用GPU 获得了在碰撞检测方面上的提速,但在基础模拟算法上的效率依旧是仿真效果存在的一个瓶颈。而基于位置的动态方法[7\~I1]能较好地解决这些问题。

基于位置的动态模拟（PBD）[7是游戏和交互式应用中变形体的实时仿真的流行方法。该方法的简单性和鲁棒性特别具有吸引力，并且最近在游戏、电影和医学模拟应用之外受到欢迎。随着知名度的提高，PBD的局限性也越来越被关注。PBD的行为取决于模拟的时间步长和迭代次数9。具体而言，随着迭代次数的增加，或随着时间步长的减少，约束条件变得非常死板。当创建具有各种材料类型的场景时，参数的这种耦合是特别可能引发问题的，如与近乎刚体相互作用的柔体。在这种情况下，提高迭代次数来获得一个对象的刚度可能会无意中改变其他仿真对象的行为。这往往需要在整体范围内重新调整刚度系数，使得创建出重复使用的仿真资产是非常困难的。例如，在布料模型中设置拉伸和弯曲约束的相对刚度，就可以单独设置迭代次数。更糟糕的是，迭代次数的影响是非线性的，难以直观地调整参数，或者很难将重新定义的值作为迭代计数的简单函数。而基于位置的层次化动态模拟方法将（PBD）的非线性Gauss-Seide1求解器转换为基于非线性多重网格的算法，从而显着增加了PBD方法的收敛速度，同时又保持了各自的特点。但是在具体的实现中笔者发现，在构造多重网格（约束网格）时，约束网格的质量严重影响了收敛的速度和模拟效果，并且在多层约束网格的层次关联上存在父子粒子关系不确定的问题。在 $X ^ { - }$ PBD[10]方法中，虽然提出了新的控制布料模拟的手段，但是对于层次化模拟的不确定问题、模拟时存在的局部收敛问题并没有解决。在最近提出的基于采样的层次化模拟方法[1]中，虽然能较好地解决层次化的网格质量问题，但是网格质量的不可控性使得其在应用中和理论上存在着很大的不确定。

为了解决以上问题，本文提出了一种新的基于位置的层次化动态算法。本文方法通过自定义决策函数来构造新的约束网格，将约束网格的构建与决策函数挂钩，不再单纯地依赖具体算法，在将非线性Gauss-Seidel求解器转换为基于非线性多重网格的过程中，提出了一种新的权重关联方式，使得层次间的关联不再依赖于不确定个数的粒子群，替而代之的是具有三角形约束的父子关系群，使得约束矫正效果更加明显，并且解决了迭代和时间步长相关的刚度问题。

为了展示布料动态模拟中形变较大的位移和角度变化的效果，展示布料在动态过程中的整体稳定性，需要建立基于实时风场下的布料模型。在现实场景中布料的形变往往伴随着风场的变化[12]，周期性飘动成为布料的典型特征[7]。为了更好地对布料进行仿真测试，笔者将风场环境应用到了模拟测试。

# 1 理论基础

# 1.1布料建模

本文使用目前流行的弹簧一质点模型为布料建模，其模型图示与说明请参见文献[13]。对于模拟动态物体，首先需要包括模型的原始位置、各粒子的动态速度与各粒子的质量等基本物理信息。其次需要建立各粒子间的约束关系。其中本文系统使用 $x _ { i }$ 表示布料网格中粒子 $i$ 的位置信息，相对应的有该粒子的速度 $\nu _ { i }$ 、质量信息 $m _ { i }$ 。最后需要添加的是布料网格中的约束信息，即各粒子间的拉伸范围以及剪切力等限制，使用 $C$ 表示。

# 1.2受力分析

在弹簧质点模型中，质点的受力有两种，一种是由质点间的弯曲弹簧、剪切弹簧对本身所产生的内力，另一种则是由重力和其他仿自然力组成的外部力。所以布料的受力可如式（1)所示。

$$
F _ { a l l } = F _ { i n } + F _ { e x }
$$

其中： $F _ { a l l }$ 表示质点所受的力； $F _ { i n }$ 表示自身的内力； $F _ { e x }$ 则表示质点所受的外力。对于受力的具体求解请参见文献[14]。

# 1.3约束矫正

在布料动态模拟中，距离约束可以理解为质点间的理论弹簧长度，即质点 $i$ 与 $j$ 间的理论距离。如果质点间的实际距离不等于理论距离，则此时就需要对质点 $i$ 与 $j$ 进行一定的位移矫正。换句话说，就是关于距离的约束矫正。不同的约束中需要不同的约束矫正方法，基于位置的动态模拟则提供了如何进行约束矫正的方法。

# 1.4基于位置的动态模拟

基于位置的动态模拟(PBD)[7,8]是一种可以直接调控三维模型的位置坐标的方法，它以迭代Gauss-Seide1方式解决位置级别的约束问题。使用PBD算法模拟可以更方便地处理模拟过程中所需添加的约束，如布料端点互相的距离约束、布料的弯曲约束或者是外界的物体碰撞约束等。

在 PBD算法中通过设定约束函数的方法为模型添加常规约束，而不是仅仅通过计算动能传导和常规力的方法来约束模型。在该方法中，首先使用动力学方程和数值计算方法提供位置变化预测，对模型所有点的坐标根据所受的力通过动力学规律得到下一个时间周期的位置坐标；然后通过模型位置坐标来检测此时的形状、位置是否满足了之前添加的常规约束，如果不满足，则根据约束矫正方程修改点的坐标，将点移动到满足约束的位置上。具体如下算法1所示。

算法1基于位置的动态模拟管线输入：布料网格，外界环境参数（如重力、风力、湿度)。输出：布料动态运动轨迹。

1. forall 粒子i do   
2. 初始化 $x _ { i } = x _ { i } ^ { 0 } , \nu _ { i } = \nu _ { i } ^ { 0 } , w _ { i } = 1 / m _ { i }$   
3. end for   
4. loop   
5. for all 粒子ido   
6. $\nu _ { i } \gets \nu _ { i } + \Delta t \cdot w _ { i } \cdot f _ { e x t } ( i )$   
7. end for   
8. for all 粒子ido   
9. $p _ { i } \gets x _ { i } + \Delta t \cdot \nu _ { i }$   
10. end for   
11. loop迭代次数   
12. 约束矫正   
13. end loop   
14. for all 粒子i do   
15. $\nu _ { i } \gets ( p _ { i } - x _ { i } ) / \Delta t$   
16. ${ \boldsymbol x } _ { i } \gets { \boldsymbol p } _ { i }$   
17. end for   
18. end loop

在该方法中通常使用约束方程对弹簧质点间的距离进行矫正，首先通过牛顿动力学方程对质点的位置进行预测；然后使用方程对超出预期阈值的质点进行矫正，使其恢复到理论位置内；最后在将这些矫正后的质点渲染模拟。对于距离约束使用的方程如式（2）所示。

$$
C ( p _ { 1 } , p _ { 2 } ) { = } | p _ { 1 } - p _ { 2 } | { - } d
$$

其中： $C$ 中的 $p _ { 1 } , p _ { 2 }$ 表示要操作的两个粒子； $\mid p _ { 1 } - p _ { 2 } \mid$ 表示两粒子点间实际距离； $d$ 表示理论距离，在本文中理论值等于原始距离。当函数值不为0时，就需要利用约束方程进行矫正。首先需要计算质点间约束变化最快的方向，即距离约束函数的梯度 $\nabla C ( p _ { 1 } , p _ { 2 } )$ ，这样就可以确保变化的方向；然后通过在该方向上矫正 $\Delta p$ 变化量；最后使约束中的两个粒子恢复到约束范围内。总结以上，可以得到

$$
C ( \boldsymbol { p } + \Delta \boldsymbol { p } ) \approx C ( \boldsymbol { p } ) + \nabla C ( \boldsymbol { p } ) \cdot \Delta \boldsymbol { p } = 0
$$

为了能更好地控制在变化方向上的幅度，可以引入一个标量 $\lambda$ 。为了进一步能体现重量对变化的影响，使用重量信息 $m$ 的倒数 $w$ 来对函数优化，从而 $\Delta p$ 就可以表示为

$$
\Delta p = - \boldsymbol { \lambda } \cdot w \frac { C ( p ) } { | \nabla C ( p ) | ^ { 2 } } \nabla C ( p )
$$

当使用距离约束时，约束函数的基数会变为2，则对应的粒子约束方程就变化为

$$
\Delta p _ { i } = - \boldsymbol { \lambda \cdot w _ { i } } \frac { C ( p _ { 1 } , p _ { 2 } ) } { | \nabla C ( p _ { 1 } , p _ { 2 } ) | ^ { 2 } } \nabla C ( p _ { 1 } , p _ { 2 } )
$$

此方法在顺序矫正距离约束时存在一个严重影响模拟效率的问题。如图1所示，在顺序矫正的过程中，首先矫正的距离约束为(a)，即 $\mathrm { { a - b } }$ ；紧接着又要对（b）进行距离约束矫正，即 $\mathrm { b { - } d }$ ，这就使得这次矫正会对上一步矫正中b的位置产生影响，使得（a）中 $\mathrm { { a - b } }$ 再次不满足其距离约束，导致约束震荡。这样的反复修改问题使布料的收敛速度大大降低，而最终的收敛则取决于模拟中迭代矫正的次数。这一现象减缓了布料收敛的速度，降低了模拟的效率。

![](images/13d0fc780a7de654348341becb35df443b52492bd40eb8581081f01e83df4580.jpg)  
图1震荡问题演示图

在实际模拟中，该方法虽然能提高一定程度的模拟速度，但是存在的约束震荡问题会使整体的收敛速度依赖于迭代矫正的次数，从而使得模拟存在很大的不稳定性。层次化方法恰好能解决这个问题，并提高布料动态模拟的效率。

# 2 传统层次化方法

# 2.1基于位置的层次化动态模拟

由于收敛取决于迭代次数，这导致了动画的帧率和模拟效率都不能达到理想的状况。为了解决收敛及效率问题，Muller[8提出了基于位置的层次化动态模拟方法(HPBD)。该方法首先通过挑选一部分核心粒子进行简化网格，构造简化层次约束网格；接着利用PBD方法对原始网格进行模拟；最后通过约束网格中各简化层对原始层进行二次约束矫正，在整体的效

果上得到了进一步的提升。

# 2.2布料建模

在使用基于位置的层次化模拟方法时，不仅需要基本的位置信息 $x _ { i }$ 、速度信息 $\nu _ { i }$ 、质量信息 $m _ { i }$ 以及各种约束信息，而且还需要用于层次网格控制的相关变量，如层次关联信息、父子网格的关联信息以及父子网格中粒子间的对应关系等。这些信息如表1所示。

表1层次化额外变量  

<html><body><table><tr><td>类型</td><td>表示符号</td></tr><tr><td>粒子类型</td><td>Fine Coarse</td></tr><tr><td>粒子i的预测位置</td><td>Xi.predict</td></tr><tr><td>Fine点的融入点</td><td>Pj</td></tr><tr><td>粒子i，j间的距离</td><td>dii</td></tr><tr><td>保存粒子i的邻接信息</td><td>i.Neighbors</td></tr><tr><td>粒子i的父亲节点</td><td>i.Parents</td></tr><tr><td>Pi对pi的影响权重</td><td>Wi</td></tr><tr><td>简化第多少层次</td><td>level</td></tr></table></body></html>

其中粒子类型信息表示层次化过程中粒子所处的层次是否包含该粒子，即当前粒子是否可以在对应约束层中剔除；Fine类型表示在目标层约束网格中将不再包含该粒子，如图2中的空心点；相对的Coarse类型则是目标层约束网格中包括的粒子，如图2中的实心黑点；Fine点的融入点 ${ { p } _ { j } }$ 表示目标层约束网格中将该Fine点的信息保存的点，如图2中的j1或j2点； $d _ { i j }$ 表示粒子 $i$ 与 $j$ 间的距离，即两粒子间的弹簧长度；i.Neighbors表示当前表示粒子 $i$ 的临接粒子，即所有与粒子 $i$ 之间有弹簧连接的粒子；i.Parents表示粒子 $i$ 融入$p _ { j }$ 后的Coarse点，如图2中的Fine粒子如果融入j1，那么其父节点就包含 j1节点，在这个局部它融入了j1,下个局部可能就用其他Fine粒子也融入了jl,所以i.Parents不是单一元素，而是个集合； $w _ { i j }$ 表示父亲节点（i.Parents）对粒子 $i$ 的约束矫正影响值，计算方法见后文；level表示在层次约束网格中的层次位置，如原网格的层次数为0，精简n次则将产生n层约束网格，为了表示当前操作的层次，使用level表示处理的层次。

![](images/410c83464c387f85fc087a58b6fbe156ef07a7b6f9b840253f6c4d95933ad8dc.jpg)  
图2约束构建  
图3约束更新

# 2.3约束网格构造方法

层次化动态模拟方法简化部分的主要目的在于构建多网格约束层次系统，使得系统可以通过逐层次、不同程度的对网格质点间的距离约束进行矫正。这样一来，单纯地依靠原始网格而产生的约束震荡现象就会大大减小。

每个层次的构建包括选择原始粒子的融入粒子、各层次约束的构建以及确定位于目标层次简化网格的Fine点。具体构建步骤如下：

a)要根据当前level层的网格选择在level $+ 1$ 层用来构建约束网格的粒子，即挑选level层中的Coarse点，该操作等价于先挑选Fine点，然后剔除。其流程大体如下：首先判断当前粒子i.Neighbors的容量是否大于 $k$ （在该系统中 $k$ 取2)，如果大于且其邻接的Fine点的fine.Neighbors也大于 $k - 1$ ，则标记为可剔除的Fine点，然后与之相关联的粒子 $j$ 从其的j.Neighbors 剔除粒子 $i$ 。换言之，就是如果粒子 $j$ 与 $i$ 有关联，则从其邻接信息 $j$ .Neighbors中删除粒子i。最后剩下的就是当前层挑选出来的Coarse粒子。接下来需要继续为挑选出来的Fine粒子 $i$ （ $p _ { i }$ )添加父亲节点i.Parents。具体流程如下：通过对i.Neighbors进行遍历,如果对应的粒子类型是Coarse，则将其填入到i.Parents即可。

2 1 (a)约束矫正前 (b)约束矫正后

b)为当前level层的生成对应的层次约束集合，首先利用Fine类型粒子 $i$ 找到其将要融入的粒子 $j$ 。需要注意的是，$j$ 的候选点有多个，如图2中的j1与j2，如果j1被选做当前层的Coarse点时，Fine类型粒子与Coarse类型粒子j1间有约束，如图3（a）中 $p _ { i }$ 与 ${ { p } _ { j } }$ 间的虚线，删除即可。如果

$$
X _ { i } \gets X _ { i } + \sum _ { j \in P _ { i } } w _ { i j } \left( p _ { j } - q _ { j } \right)
$$

Fine类型粒子邻接的粒子与融入点 ${ \boldsymbol { p } } _ { j }$ 无连接，此时需要先删除其与 $p _ { i }$ 的连接，然后添加一个新约束，如图3（b）中的${ \boldsymbol { p } } _ { t }$ 。如果Fine类型粒子邻接的粒子与融入粒子 ${ \boldsymbol { p } } _ { j }$ 有共同的邻接粒子，删除此约束即可。以此类推，剩下的约束即当前简化层的约束，至此当前层次的简化网格就建立完成了。

c)将简化后的约束叠加在原网格上进行收敛加速。这部分的过程可如算法2所示。

算法2HPBD 新层次构造算法输入：上一层网格约束集合。

输出：新层网格约束集合。

1. 复制所有层次level-1 的约束   
2. for all 粒子i do   
3. if $p _ { i } . t y p e = f i n e$ then   
4. for all $p _ { i }$ .neighbors $t$ do   
5. for all Pj.neighbors m do   
6. if $p _ { i }$ .neighborst $\boldsymbol { \mathbf { \overline { { \mathbf { \Pi } } } } } = \boldsymbol { p } _ { j }$ .neighborsm   
7. 删除该约束   
8. else   
9. 更新该约束   
10. end if   
11. end for   
12. end for   
13. end if   
14. end for

其中HPBD约束矫正从最精简层开始计算，循环迭代至最精密层，这样通过父节点信息与子节点信息的传递保存了布料的关键特征，再通过利用简化网格约束对原网格矫正。这样一来，在获得信息对等性的同时不仅将布料信息还原于精密原始网格，而且使得计算量大幅度减少，保证了效率，并且保证了布料模拟的真实性。在层次信息传递的步骤上，数值更新尤为重要，具体计算如式（6）所示。

其中： $P _ { i }$ 是粒子 $i$ 的父亲节点的索引； $\boldsymbol { \mathbf { W } } _ { i j }$ 表示 $p _ { i }$ 的父亲节点 $p _ { j }$ 对其的影响权重； ${ \boldsymbol { p } } _ { j }$ 表示粒子 $i$ 的父亲节点的实际位置； $q _ { j }$ 表示粒子 $i$ 的父亲节点的预测位置。关于 $\mathbf { W } _ { i j }$ 的计算，本文使用粒子 $i$ 与当前父节点 ${ { p } _ { j } }$ 间的距离 $d _ { i j }$ 与粒子 $i$ 与所有父节点 ${ p } _ { j }$ 间的总距离进行求比进行获取，如式（7)

（8）所示。先求取未单位向量化的值 $\hat { \mathbf { W } } _ { i j }$ ，最后通过向量化处理得到权重。

$$
\hat { \bf w } _ { i j } = \frac { 1 } { d _ { i j } / \operatorname* { m a x } ( d _ { i j } ) + \varepsilon }
$$

$$
\mathbf { W } _ { i j } = \widehat { \mathbf { W } } _ { i j } / \sum _ { j } \widehat { \mathbf { W } } _ { i j }
$$

在式（7）中， $\varepsilon$ 表示一个特别小的常数； $\operatorname* { m a x } ( d _ { i j } )$ 表示在粒子 $i$ 与其融入粒子 $j$ 之间最大的距离。需要注意的是，系统中 $d _ { i j }$ 与 $\boldsymbol { \mathbf { W } } _ { i j }$ 是随所在层次level的变化而变化的，每个层次中有着不同的Coarse粒子，也对应着不同的dij与Wij。

# 3 规则网格层次化方法

# 3.1传统方法的问题

在传统方法中，如果将布料网格不同层次的约束网格提取出来进行对比就会发现，随着层次数的不断增加，其中的不规则多边形数量也越来越多，如图4所示。

![](images/c50b6df210d596cd8c4e85dc62f2ff3bc9e66eccb0a0b62f58fc6ad59c91bb9f.jpg)  
图4传统层次化约束网格

从以上可以看出，在随着层次数的增多，传统算法在产生约束网格的过程中存在一定的问题，使得在构造层次化网格系

统时将产生大面积的不规则多边形，使得约束网格的质量严重影响矫正方向，造成了整体的约束效果与理论状态产生不可预估的区别，这将导致布料模拟的最终收敛状态与原始模拟存在一定的误差。

传统层次化方法中，在约束更新时构造属于自己的网格系统，但是会存在大量的不规则多边形，虽然这样在整体的效果接近，但在某些特定的区域中，这将使得方法失去可靠性。虽然文献[11]中提到的采样化方式可以解决这个问题，但是采样的随机性和不可控性使得应用成为难题，并且在采样层次化方法中，层次网格建立的时间复杂度依赖于采样和网格重建算法，而这两种算法都是高时间复杂度的，所以在建立系统上会花费特别多的资源。规则网格层次化方法将利用数学构造方法实现高度可控的网格系统，实现局部与整体的双重规则的要求，达到与理论效果接近的状态，并且在构建层次约束网格的效率上得到了质的飞跃。

# 3.2层次约束网格的建立

对于层次约束系统的建立首先需要确定基准网格。本文首先将原始网格作为基准网格；然后通过对基准网格的特点进行分析，挑选出最适合的决策函数，从而确定模拟材料的的层次约束模型；最后根据挑选出的Fine点进行构造层次约束网格。

在挑选次层粒子（Coarse点）的过程需要一定的决策函数，例如对网格的列和行都需要不同的函数 $f ( x )$ 和 $g ( y )$ 对各自点的个数进行确定，然后再通过离散的方式确定每个粒子的具体位置。如图5所示，在图5(a)到(b)，最后简化到(d)的过程中，列和行都使用了相同的线性函数。在选择函数上，凡是属于递减类型函数都可以作为约束网格的决策函数。不同的网格往往需要根据实际情况确定其在行列上不同的决策函数。例如在图5中，首先在网格行的初始粒子个数为5，列的初始粒子个数也为5，并且在常规的减函数中希望存在比较多的层次约束网格，使得其变化保持一致，所以本文使用相同的线性函数进行构造约束网格，保证行与列的变化一致性。

$$
f ( l _ { x } ) = k _ { 1 } l + b _ { 1 }
$$

$$
g ( l _ { y } ) = k _ { 1 } l + b _ { 1 }
$$

一(a)原始层 (b)第一层 (c)第二层 (d)第三层

在式（9）（10）中： $k _ { \mathrm { 1 } }$ 、 $b _ { 1 }$ 均为常数； $f ( l _ { x } )$ 为规则网格的行粒子个数； $g ( l _ { y } )$ 为规则网格的列粒子数目； $l$ 代表处理的所处层次。

再比如，当行的粒子初始个数为100，列的初始粒子为30，希望在此网格中比较密集的粒子能够相对缓慢的递减，比较疏松的列粒子能够均匀递减，所以此时在列的简化过程中，本文使用线性函数作为决策函数；在行的简化过程中，使用余弦函数作为决策函数。

$$
f ( l _ { x } ) = k _ { 3 } \cos ( \omega l ) + b _ { 3 }
$$

$$
g ( l _ { y } ) = k _ { 4 } l + b _ { 4 }
$$

在式（11）（12）中： $k _ { 3 }$ 、 $k _ { 4 }$ 、 $\omega$ 、 $b _ { 3 }$ 和 $b _ { 4 }$ 均为常数;$f ( l _ { x } )$ 为规则网格的行粒子个数； $g ( l _ { y } )$ 为规则网格的列粒子数目； $l$ 代表处理的所处层次。

在这个过程中，首先需要确定最小层次中行列的粒子个数和最大层次中行列的粒子个数，如图5中最大层次的行列粒子个数均为2，最小层次的行列个数均为5。在此例中，最小层次的行粒子个数为100，最大层的行粒子个数为2。最小层次的列粒子个数为30，最大层的行粒子个数为2。在此便可以确定其中变量的具体值，从而可以确定出各层次的粒子具体位置。本例如表2所示。

表2粒子各层次变化  

<html><body><table><tr><td>变化</td><td>初始 层</td><td>第1 层</td><td>第2 层</td><td>第3 层</td><td>第4 层</td><td>中间</td><td>最后 层</td></tr><tr><td>行</td><td>100</td><td>85</td><td>72</td><td>53</td><td>34</td><td>…</td><td>2</td></tr><tr><td>列</td><td>30</td><td>26</td><td>22</td><td>18</td><td>14</td><td>…</td><td>2</td></tr></table></body></html>

在确定每层中每行的粒子个数与每列的粒子个数后，需要通过离散的方式构造网格中每个点的位置信息。例如图5(a)中的粒子通过 $g ( y )$ 确定了下层每行的粒子个数，同样通过$f ( x )$ 确定了每列的粒子个数，然后计算出最长行（列）端点之间的距离，求其离散增长步长，从而确定出下一层次的网格模型(图5(b))。然后图5 (b)重复同样的操作，直至到达定义的终止条件。在这里，称图5 (b)为(a)的父网格，称图5 (c)为(b)的父网格，并以此类推。

此时，父网格的运动轨迹如何确定又成了另一个核心问题。笔者使用了一个传统的解决方案，利用最短距离确定其同位素，即在构建层次系统时，距离该粒子最近的原网格粒子将与该粒子有相同的位置与位移关系，这就确保了约束网格的运动特征与原网格的一致性。

# 3.3 模拟关联

确定了层次系统，如何将约束信息串联起来是这部分的核心问题。正如图6所示，该部分为图5(b)到(c)，其中蓝色的为上层删选掉的粒子，即Fine点，黑色的为本层的粒子，即Coarse点（见电子版)，并且也可以将(c)视为(b)的父网格。为了将父网格的约束矫正信息能够传递给子网格，需要在构建约束网格系统时，确定子网格粒子在父网格的父亲粒子们，并确定对应的权值信息。

![](images/58b6b4907f042de28dc4fc105834c02172a5d784ced71f401e4c932080d5fc8a.jpg)  
图6父子粒子关系

对于图6（b）中的 $a$ 、 $b$ 、 $\boldsymbol { c }$ 与 $P$ 均存在于三维空间，则必然存在一组一维变量 $w _ { 1 }$ 、 $w _ { 2 } , \ w _ { 3 }$ ，使得

$$
P = w _ { 1 } a + w _ { 2 } b + w _ { 3 } c
$$

这个式子等价于

$$
\left( { \begin{array} { l } { p _ { x } } \\ { p _ { y } } \\ { p _ { z } } \end{array} } \right) = \left( { \begin{array} { l l l } { a _ { 1 x } } & { b _ { 1 x } } & { c _ { 1 x } } \\ { a _ { 1 y } } & { b _ { 1 y } } & { c _ { 1 y } } \\ { a _ { 1 z } } & { b _ { 1 z } } & { c _ { 1 z } } \end{array} } \right) \cdot { \left( \begin{array} { l } { w _ { 1 } } \\ { w _ { 2 } } \\ { w _ { 3 } } \end{array} \right) }
$$

假如使用 $P$ 表示Fine粒子的位置矩阵， $A$ 表示其父亲节点的位置矩阵，W表示其权重矩阵，则有

$$
P = A \cdot W
$$

则可以推导出

$$
W = { \boldsymbol { A } } ^ { - 1 } \cdot { \boldsymbol { P } }
$$

求出父子权值后，便可以在模拟时使用对应权值更新子节点位置，从而避免了约束震荡问题，加快收敛速度。

# 3.4模拟流程

对于本文的层次化方法，在模拟的过程中，首先需要确定层次系统，其次在约束矫正的过程中首先需要对原始布料进行初始化模拟，即通过力学方程预测出下一时间步长布料所有点的位置，然后在约束网格中从最粗的一层开始回归矫正，即如图5中利用图5 (d)矫正(c)，利用(c)矫正(b)，直至到原始网格(a)，这样的层次化矫正可以减少原始动态模拟方法中在约束矫正中使用的迭代次数和总体的约束数量。在具体的矫正过程中，子网格中的粒子利用父网格中父亲节点们获取其新的位置的信息，正如第3章中的式（6）所示。整体流程如下算法3所示。

算法3本文层次化模拟管线输入：布料网格，外界环境参数（如重力、风力、湿度)。

输出：布料动态运动轨迹。

1. 构造约束网格  
2 for all 粒子i do  
3 初始化 $x _ { i } = x _ { i } ^ { 0 } , \nu _ { i } = \nu _ { i } ^ { 0 } , w _ { i } = 1 / m _ { i }$   
4 end for  
5 loop  
6 for all 粒子i do  
7 $\nu _ { i } \gets \nu _ { i } + \Delta t \cdot w _ { i } \cdot f _ { e x t } ( i )$   
8 end for  
9 for all 粒子i do  
10 $p _ { i } \gets x _ { i } + \Delta t \cdot \nu _ { i }$   
11 end for  
12 loop 迭代次数  
13 原约束矫正  
14 end loop  
15 for all 约束网格(逆序）do  
16 $p _ { i }  p _ { i } + \sum _ { j \in i . P a r e n t s } w _ { i j } ( x _ { j } - x _ { j . p r e d i c t } )$   
17 回归约束矫正  
18 end for  
19 for all 粒子i do  
20 $\nu _ { i } \gets ( p _ { i } - x _ { i } ) / \Delta t$   
21 ${ \boldsymbol x } _ { i } \gets { \boldsymbol p } _ { i }$   
22 end for  
23 end loop

在此处，为了防止预测位置表示符号的重复带来的混淆，基本的位置预测使用 $p _ { i }$ 表示,父类的位置预测使用 $\boldsymbol { x } _ { j . p r e d i c t }$ 表示。与原层次方法不同的是，在回归约束矫正的过程中，不再是将父层的矫正信息传递至子层，而是直接传递到原始层，这样不再过分依赖某个关键粒子，便使得整体的效果接近。

# 4 实验结果分析与效果对比

# 4.1添加风场

为了校验基于规则网格的层次化动态模拟方法，本文采用文献[13,14]提出的随机风场模型，并结合Perlin噪声函数产生的钟摆[15]风场进行测试。首先使用三角形网格来表示风场中布料模型，在分析过布料的网格结构后，可以确定每个三角形的顶点也是其相邻三角形的顶点。在计算风力时，由于使用的模型是离散型，所以先计算顶点在每个三角形面片上的风力，再通过加权平均来求取每个顶点所受的风力，最后根据空气动力学理论中空气流体对物体的作用力来计算具体三角形面片所受的风力。计算方法如式（16）所示。

$$
F _ { i } = \frac { 1 } { 2 } \hat { C } \rho \nu ^ { 2 } S _ { i }
$$

其中： $\hat { C }$ 表示风力系数，一般取值在 $0 . 3 { \sim } 0 . 6$ 间； $\rho$ 表示空气密度，大小一般取 $2 . 3 7 e - 3 g / m ^ { 3 }$ ； $\nu$ 表示风速； $S _ { i }$ 表示第 $i$ 个三角形面片的面积；而 $F _ { i }$ 表示第 $i$ 个三角形面片所受的力。对于离散点上的力，需要先求取所有与其相关联的三角面片的受力，再通过求取平均值来计算。

# 4.2 模拟效果对比

本文使用了基于位置的动态模拟、传统的层次化方法、基于采样的层次化模拟方法与规则网格层次化方法对布料网格进行模拟。对于本文方法，首先将原始布料视为基准网格，然后利用自定义校准函数确定层次化约束系统，紧接着利用层次间关系确定粒子之间的关联，使得约束信息的有效传递，最终完整建立层次化系统。在模拟的过程中，首先需要对原始网格利用动力学方程进行初步的位置预估，然后从最精简层到最精细层分别利用层次系统中对应的层次约束进行矫正，使得布料网格信息在层次传递下保持一致。

在基于位置的动态模拟中，为了能更好地达到收敛效果，只能单一地增加约束的矫正次数，存在着大量的约束震荡问题。

在层次化的动态模拟中，虽然添加了更多的约束，但是由于不同层次约束的添加却使得迭代次数的减少，而且在总的约束数量上比原模拟少了许多，这就直接造成了效率的提升。并且在模拟的效果上，由于不同层分别对整体各范围进行不同程度的约束矫正，使得模拟效果远好于仅仅增加迭代次数、增加约束矫正次数的原模拟方法。实验模拟效果如图7所示。

在以下的测试中，核心硬件架构为 $\mathrm { x 8 6 }$ ，处理器为Intel酷睿（型号i7-4710MQ），搭载Windows系统，同时使用开源图形库OpenGL使用单线程绘图方式进行渲染。

首先对基于位置的动态模拟方法进行模拟采样，然后在同样的情况下分别对传统层次化方法、基于采样的层次化模拟方法、基于规则网格的层次化方法进行模拟采样。以下是在重力为0.98牛顿、迭代次数为5、时间为3s的标准条件下进行自由落体实验的对比图（图7-第一行）。

![](images/2f445c0a3b8278a4a15c5e0558263746f2fe31c7d7ffb77f3bd00c1706c87f83.jpg)

为了测试布料在风场中形变的稳定程度，本文在定向钟摆风场下进行测试，效果如图7第2、3行所示。该部分实验在重力为0.98牛顿，迭代次数为5，约束网格层次数为3的情况下完成。其中上方一行为本文方法下的模拟效果，下面一行为传统方法的模拟效果。通过对比可以看出，传统方法虽然提高了收敛速度，但是本文方法在动态条件下正如在风场下的效果所示，原始方法下布料的拉伸状态与原网格差距较大。这巧合说明基于规则网格的层次化方法与理论状态更加接近，在稳定性等方面上做得更加突出，在粒子位置的收敛速度上效果明显。

为了将各种方法的性能以及收敛速度显像地表示出来，笔者使用最常用的弹簧变化率对对传统方法、原始基于位置的动态方法(PBD）、原始层次化方法(HPBD）、采样层次化方法（SHPBD）以及基于规则网格的层次化方法（GHPBD）进行测试比对，以说明各种方法最终收敛状态之间的差距。测试数据如表3所示。

表3稳定弹簧相对变化率比较  

<html><body><table><tr><td>方法</td><td>PBD</td><td>HPBD</td><td>SHPBD</td><td>GHPBD</td></tr><tr><td>层次化1层</td><td>67%</td><td>63%</td><td>46%</td><td>37%</td></tr><tr><td>层次化3层</td><td></td><td>48%</td><td>34%</td><td>23%</td></tr><tr><td>层次化5层</td><td></td><td>41%</td><td>26%</td><td>19%</td></tr></table></body></html>

而在传统方法中，最终收敛状态下的相对变化率为 $5 2 \%$ ，虽然在相对效果好于最原始的PBD方法，但是在模拟的过程中的耗时却远大于PBD系列方法。例如在单帧模拟耗时上，传统方法耗时为 $1 3 2 ~ \mathrm { m s }$ 。而基于位置的动态模拟、传统层次方法和基于采样的方法分别为97ms、34ms和 $4 5 ~ \mathrm { \ m s }$ ，而本文方法的时间为 $4 2 \ \mathrm { \ m s }$ 。

通过在相同条件下对原始动态模拟方法、传统的层次化动态模拟方法与基于规则网格的层次化模拟方法的模拟对比可知，本文提出的基于规则网格的层次化方法，布料的收敛状态更快地接近理想状态，证明基于位置的层次化模拟方法确实加速了收敛，并且在布料的动态风场模拟中效果稳定。

# 4.3 收敛速度对比

布料网格随着时间的移动而位置趋向于最终位置的变化，能够说明一种方法的收敛速度。在此，笔者分别对原始方法、传统层次化方法和本文方法使用同样的测试条件进行逐帧比对，并从这个过程中比较其收敛速度。

通过对比发现随着时间的移动，层次化模拟的优势逐渐显现出来，传统方法在中期体现出优势，但是后期与基于位置的动态方法表现收敛速度开始下降；而本文方法从中前期就开始显示出其优越性，而且一直保持领先。为了更好地说明本文方法的收敛加速效果，测试使用了弹簧变化率(表示布料趋于稳定时的布料形变指数)逐帧比对。而对于采样方法，由于依赖于采样算法与重构算法，使得其该部分的测试数值局限于一个范围，所以本文不提供其该部分的弹簧率测试数据。测试如图（8）所示。

![](images/bd3046749625836213f6900c73d44fb878838a9f3b29ff3e2ddc785e3d810460.jpg)  
图7模拟效果对比  
图8弹簧变化率对比

通过图8可以看出，使用本文提出的基于位置的层次化模拟方法时，虽然耗时相比较略微增长，但是布料的整体弹簧变化率能更快地趋向于布料整体收敛位置。

# 5 结束语

本文首先对布料分别利用基于位置的动态模拟方法、传统层次化方法模拟方法和本文提出的基于规则网格的层次化方法进行模拟，然后通过测试说明了基于规则网格层次化方法在动态条件下的稳定性，最后通过对比说明了本文方法在效率及效果上面的优越性。在传统方法的实现过程中，随着层次数的增加，加速约束网格中存在的不规则多边形越来越多，这一网格的质量问题使得布料的收敛趋于未知，导致了部分区域的收敛与理论上存在一定的差异，并且在构造层次系统的过程中对于细节的控制率比较低。传统层次化方法为了解决最初的约束震荡问题而带来的细节控制问题一直未被解决，本文针对这个问题提出了基于规则网格层次化方法，创新性地使用行列决策函数来确定层次约束网格，并结合采样层次化方法中的关联方式成功解决了传统方法的效率问题、约束震荡问题以及约束网格质量问题导致的收敛不确定问题，在父子粒子的关系控制上达到新的高度，在模拟细节上有了更好的表现，在风场的动态测试中表现良好。

# 参考文献：

[1]Lu J,Zheng C.Dynamic cloth simulation by isogeometric analysis [J]. Computer Methods in Applied Mechanics & Engineering,2014,268 (1): 475-493.   
[2]Breen D E,House D H,Getto PH.A physically-based particle model of woven cloth [J].The Visual Computer,1992,8(5): 264-277.   
[3]Provot X.Deformation constraints in a mass-spring model to describe rigid cloth behavior [C]//Proc of GraphicsInterface.1995:147-154.   
[4]Kikuuwe R.A time-integration method for stable simulation of extremely deformable hyperelastic objects [J].The Visual Computer, 2016,32 (10): 1335-1346.   
[5]Wang Z,Tang M,TongR,et al.TightCCD: efficient and robust continuous collision detection using tight error bounds [C]//Proc of Computer Graphics Forum. 2015: 289-298.   
[6]Du Peng,Zhao Jieyi,Pan Wenbin,et al.GPU accelerated real-time collision handling in virtual disassembly [J].Journal of Computer Science and Technology,2015,30 (3): 511-518.   
[7]Müller M,Heidelberger B,Hennix M,et al.Position based dynamics [J]. Journal of Visual Communication and Image Representation,2oo7,18 (2): 109-118.   
[8]Müller M.Hierarchical position based dynamics [C]// Proc of the 5th Workshop on Virtual Reality Interactions and Physical Simulations.2008: 1-10.   
[9]Bender J,Dan K,Charrier P,et al.Position-based simulation of continuous materials [M].[S.1.] :Pergamon Press,2014.   
[10] Chentanez N, Chentanez N.XPBD: position-based simulation of compliant constrained dynamics [C]//Proc of International Conference on Motion in Games.[S.1.]:ACMPress,2016: 49-54.   
[11]Wang M,Zheng H,QianK,et al.Sampling hierarchical position-based dynamics simulation [C]// Proc of International Workshop on Next Generation Computer Animation Techniques.[S.1.]: Springer,2017: 45-55.   
[12]吕梦雅，许立瑶，唐勇，等．随机可控风场中三维布料实时仿真[J]. 小型微型计算机系统,2015,36(12):2769-2772.   
[13]顾沁婷，李艳梅，刘翔．基于质点一弹簧模型的织物形象化仿真技术与 展望[J].纺织学报,2013,34(3):147-153.   
[14]杨宇科．一种风场作用下粒子系统火焰的动态模拟[J].计算机应用与 软件，2013,30(1):132-135,175.   
[15]赖秋凤，侯进．基于噪声函数的随机风场作用的动态布料研究[J]．计 算机仿真,2015,32(12):192-196.